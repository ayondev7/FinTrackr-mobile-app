import React, { useState } from 'react';
import { View, Text, ScrollView, Dimensions } from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import {
  AnalyticsTypeFilter,
  StatsCardsGrid,
  MonthlyOverviewChart,
  BalanceTrendChart,
  DistributionChart,
} from '../components/analytics';
import { useTransactionStore, useThemeStore, useUserStore } from '../store';
import { colors } from '../constants/theme';

export const AnalyticsScreen = () => {
  const insets = useSafeAreaInsets();
  const { transactions } = useTransactionStore();
  const { theme } = useThemeStore();
  const { user } = useUserStore();
  const themeColors = colors[theme];
  const screenWidth = Dimensions.get('window').width;
  const isDark = theme === 'dark';
  
  const [analyticsType, setAnalyticsType] = useState<'expense' | 'revenue' | 'both'>('expense');

  const chartConfig = {
    backgroundColor: themeColors.card,
    backgroundGradientFrom: themeColors.card,
    backgroundGradientTo: themeColors.card,
    decimalPlaces: 0,
    color: (opacity = 1) => themeColors.primary,
    labelColor: (opacity = 1) => isDark ? `rgba(241, 245, 249, ${opacity})` : `rgba(17, 24, 39, ${opacity})`,
    style: {
      borderRadius: 16,
    },
    propsForDots: {
      r: "6",
      strokeWidth: "2",
      stroke: themeColors.primary
    }
  };

  const getFilteredTransactions = () => {
    if (analyticsType === 'both') return transactions;
    return transactions.filter((txn) => txn.type === analyticsType);
  };

  const expenseData = transactions
    .filter((txn) => txn.type === 'expense')
    .reduce((acc: any[], txn) => {
      const existing = acc.find((item) => item.name === txn.category);
      if (existing) {
        existing.amount += txn.amount;
      } else {
        acc.push({ name: txn.category, amount: txn.amount });
      }
      return acc;
    }, []);

  const revenueData = transactions
    .filter((txn) => txn.type === 'revenue')
    .reduce((acc: any[], txn) => {
      const existing = acc.find((item) => item.name === txn.category);
      if (existing) {
        existing.amount += txn.amount;
      } else {
        acc.push({ name: txn.category, amount: txn.amount });
      }
      return acc;
    }, []);

  const getChartData = () => {
    let dataToUse = [];
    if (analyticsType === 'expense') {
      dataToUse = expenseData;
    } else if (analyticsType === 'revenue') {
      dataToUse = revenueData;
    } else {
      dataToUse = [...expenseData, ...revenueData];
    }
    return dataToUse;
  };

  const chartData = getChartData();
  const pieData = chartData.map((item, index) => ({
    name: item.name,
    amount: item.amount,
    color: Object.values(themeColors.chart)[index % 10],
    legendFontColor: isDark ? '#F1F5F9' : '#111827',
    legendFontSize: 12,
  }));

  return (
    <ScrollView 
      className="flex-1 bg-gray-50 dark:bg-slate-900"
      contentContainerStyle={{ paddingBottom: 100 }}
    >
      <View className="p-6" style={{ paddingTop: insets.top + 24 }}>
        <Text className="text-gray-900 dark:text-white text-3xl font-bold mb-4">
          Analytics
        </Text>

        <AnalyticsTypeFilter
          analyticsType={analyticsType}
          onSelect={setAnalyticsType}
        />

        <StatsCardsGrid
          transactionCount={transactions.length}
          isDark={isDark}
        />

        <MonthlyOverviewChart
          screenWidth={screenWidth}
          analyticsType={analyticsType}
          chartConfig={chartConfig}
        />

        <BalanceTrendChart
          screenWidth={screenWidth}
          chartConfig={chartConfig}
        />

        <DistributionChart
          analyticsType={analyticsType}
          pieData={pieData}
          chartData={chartData}
          chartConfig={chartConfig}
          isDark={isDark}
        />
      </View>
    </ScrollView>
  );
};
            className={`flex-1 py-2.5 px-4 rounded-xl ${
              analyticsType === 'expense'
                ? 'bg-red-500'
                : 'bg-gray-100 dark:bg-slate-700'
            }`}
          >
            <Text
              className={`text-center font-semibold ${
                analyticsType === 'expense'
                  ? 'text-white'
                  : 'text-gray-700 dark:text-gray-300'
              }`}
            >
              Expenses
            </Text>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={() => setAnalyticsType('revenue')}
            className={`flex-1 py-2.5 px-4 rounded-xl ${
              analyticsType === 'revenue'
                ? 'bg-green-500'
                : 'bg-gray-100 dark:bg-slate-700'
            }`}
          >
            <Text
              className={`text-center font-semibold ${
                analyticsType === 'revenue'
                  ? 'text-white'
                  : 'text-gray-700 dark:text-gray-300'
              }`}
            >
              Revenue
            </Text>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={() => setAnalyticsType('both')}
            className={`flex-1 py-2.5 px-4 rounded-xl ${
              analyticsType === 'both'
                ? 'bg-indigo-600 dark:bg-indigo-500'
                : 'bg-gray-100 dark:bg-slate-700'
            }`}
          >
            <Text
              className={`text-center font-semibold ${
                analyticsType === 'both'
                  ? 'text-white'
                  : 'text-gray-700 dark:text-gray-300'
              }`}
            >
              Both
            </Text>
          </TouchableOpacity>
        </View>

        <View className="flex-row flex-wrap justify-between gap-y-4 mb-6">
          {/* Avg Daily Card - Blue Gradient */}
          <View className="w-[48%]">
            <View 
              className="rounded-3xl p-5 shadow-2xl"
              style={{
                backgroundColor: isDark ? '#1E293B' : '#EFF6FF',
                borderWidth: 2,
                borderColor: isDark ? '#3B82F6' : '#BFDBFE',
              }}
            >
              <View className="flex-row items-center justify-between mb-3">
                <View 
                  className="p-3 rounded-2xl shadow-md"
                  style={{ backgroundColor: isDark ? '#3B82F6' : '#60A5FA' }}
                >
                  <Activity size={24} color="#FFFFFF" />
                </View>
                <View 
                  className="px-3 py-1.5 rounded-full shadow-sm"
                  style={{ backgroundColor: '#10B981' }}
                >
                  <Text className="text-white text-xs font-bold">â†— 12%</Text>
                </View>
              </View>
              <Text className="text-blue-600 dark:text-blue-300 text-xs font-bold uppercase tracking-wide mb-1">
                Avg. Daily
              </Text>
              <Text className="text-blue-900 dark:text-blue-100 text-2xl font-black">
                $42.50
              </Text>
            </View>
          </View>

          {/* Total Transactions Card - Purple Gradient */}
          <View className="w-[48%]">
            <View 
              className="rounded-3xl p-5 shadow-2xl"
              style={{
                backgroundColor: isDark ? '#1E1B3A' : '#F5F3FF',
                borderWidth: 2,
                borderColor: isDark ? '#8B5CF6' : '#DDD6FE',
              }}
            >
              <View className="flex-row items-center justify-between mb-3">
                <View 
                  className="p-3 rounded-2xl shadow-md"
                  style={{ backgroundColor: isDark ? '#8B5CF6' : '#A78BFA' }}
                >
                  <CreditCard size={24} color="#FFFFFF" />
                </View>
                <View 
                  className="w-8 h-8 rounded-full items-center justify-center"
                  style={{ backgroundColor: isDark ? '#8B5CF6' : '#A78BFA' }}
                >
                  <Text className="text-white text-lg font-bold">{transactions.length}</Text>
                </View>
              </View>
              <Text className="text-purple-600 dark:text-purple-300 text-xs font-bold uppercase tracking-wide mb-1">
                Total Txns
              </Text>
              <Text className="text-purple-900 dark:text-purple-100 text-2xl font-black">
                {transactions.length} Txns
              </Text>
            </View>
          </View>

          {/* Max Expense Card - Red Gradient */}
          <View className="w-[48%]">
            <View 
              className="rounded-3xl p-5 shadow-2xl"
              style={{
                backgroundColor: isDark ? '#2D1B1E' : '#FEF2F2',
                borderWidth: 2,
                borderColor: isDark ? '#EF4444' : '#FECACA',
              }}
            >
              <View className="flex-row items-center justify-between mb-3">
                <View 
                  className="p-3 rounded-2xl shadow-md"
                  style={{ backgroundColor: isDark ? '#EF4444' : '#F87171' }}
                >
                  <TrendingDown size={24} color="#FFFFFF" />
                </View>
                <View 
                  className="px-2 py-1 rounded-lg"
                  style={{ backgroundColor: isDark ? '#7F1D1D' : '#FEE2E2' }}
                >
                  <Text className="text-red-600 dark:text-red-400 text-xs font-bold">MAX</Text>
                </View>
              </View>
              <Text className="text-red-600 dark:text-red-300 text-xs font-bold uppercase tracking-wide mb-1">
                Max Expense
              </Text>
              <Text className="text-red-900 dark:text-red-100 text-2xl font-black">
                $250.00
              </Text>
            </View>
          </View>

          {/* Max Revenue Card - Green Gradient */}
          <View className="w-[48%]">
            <View 
              className="rounded-3xl p-5 shadow-2xl"
              style={{
                backgroundColor: isDark ? '#1B2D23' : '#F0FDF4',
                borderWidth: 2,
                borderColor: isDark ? '#10B981' : '#BBF7D0',
              }}
            >
              <View className="flex-row items-center justify-between mb-3">
                <View 
                  className="p-3 rounded-2xl shadow-md"
                  style={{ backgroundColor: isDark ? '#10B981' : '#34D399' }}
                >
                  <TrendingUp size={24} color="#FFFFFF" />
                </View>
                <View 
                  className="px-2 py-1 rounded-lg"
                  style={{ backgroundColor: isDark ? '#065F46' : '#D1FAE5' }}
                >
                  <Text className="text-green-600 dark:text-green-400 text-xs font-bold">TOP</Text>
                </View>
              </View>
              <Text className="text-green-600 dark:text-green-300 text-xs font-bold uppercase tracking-wide mb-1">
                Max Revenue
              </Text>
              <Text className="text-green-900 dark:text-green-100 text-2xl font-black">
                $5,000.00
              </Text>
            </View>
          </View>
        </View>

        <Card className="mb-6 p-4">
          <Text className="text-gray-900 dark:text-white text-lg font-bold mb-4">
            Monthly {analyticsType === 'expense' ? 'Expenses' : analyticsType === 'revenue' ? 'Revenue' : 'Overview'}
          </Text>
          <BarChart
            data={{
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
              datasets: [{
                data: [1200, 1500, 1800, 1300, 1600, 2000],
              }],
            }}
            width={screenWidth - 80}
            height={220}
            chartConfig={{
              ...chartConfig,
              color: (opacity = 1) => 
                analyticsType === 'revenue' 
                  ? `rgba(16, 185, 129, ${opacity})` 
                  : analyticsType === 'expense'
                  ? `rgba(239, 68, 68, ${opacity})`
                  : themeColors.primary,
              propsForBackgroundLines: {
                strokeWidth: 0,
              },
            }}
            style={{
              borderRadius: 16,
            }}
            yAxisLabel="$"
            yAxisSuffix=""
            fromZero
            showValuesOnTopOfBars
            withInnerLines={false}
          />
        </Card>

        <Card className="mb-6 p-4">
          <Text className="text-gray-900 dark:text-white text-lg font-bold mb-4">
            Balance Trend
          </Text>
          <LineChart
            data={{
              labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
              datasets: [{
                data: [10000, 11000, 10500, 12000, 11800, 13000],
              }],
            }}
            width={screenWidth - 80}
            height={220}
            chartConfig={{
              ...chartConfig,
              color: (opacity = 1) => `rgba(16, 185, 129, ${opacity})`,
              propsForBackgroundLines: {
                strokeWidth: 0,
              },
            }}
            bezier
            style={{
              borderRadius: 16,
            }}
            yAxisLabel="$"
            withInnerLines={false}
            withOuterLines={false}
            withVerticalLines={false}
            withHorizontalLines={false}
          />
        </Card>

        <Card className="mb-6 p-4">
          <Text className="text-gray-900 dark:text-white text-lg font-bold mb-4">
            {analyticsType === 'expense' ? 'Expense' : analyticsType === 'revenue' ? 'Revenue' : 'Transaction'} Distribution
          </Text>
          {pieData.length > 0 ? (
            <View className="items-center">
              <View className="relative items-center justify-center" style={{ width: 220, height: 220 }}>
                <PieChart
                  data={pieData}
                  width={220}
                  height={220}
                  chartConfig={chartConfig}
                  accessor="amount"
                  backgroundColor="transparent"
                  paddingLeft="48"
                  hasLegend={false}
                  center={[0, -8]}
                  absolute
                />
                {/* Donut Hole */}
                <View 
                  className="absolute w-32 h-32 bg-white dark:bg-slate-800 rounded-full items-center justify-center"
                  style={{ pointerEvents: 'none', top: 46, left: 46 }}
                >
                  <Text className="text-gray-500 dark:text-gray-400 text-xs">Total</Text>
                  <Text className="text-gray-900 dark:text-white font-bold text-lg">
                    ${chartData.reduce((sum, item) => sum + item.amount, 0).toFixed(0)}
                  </Text>
                </View>
              </View>
              
              {/* Custom Legend */}
              <View className="flex-row flex-wrap justify-center gap-3 mt-4">
                {pieData.map((item, index) => (
                  <View key={index} className="flex-row items-center gap-2">
                    <View 
                      className="w-3 h-3 rounded-full" 
                      style={{ backgroundColor: item.color }} 
                    />
                    <Text className="text-gray-600 dark:text-gray-300 text-xs">
                      {item.name} ({Math.round((item.amount / chartData.reduce((sum, i) => sum + i.amount, 0)) * 100)}%)
                    </Text>
                  </View>
                ))}
              </View>
            </View>
          ) : (
            <Text className="text-gray-500 text-center py-8">
              No {analyticsType === 'both' ? 'transaction' : analyticsType} data available
            </Text>
          )}
        </Card>
      </View>
    </ScrollView>
  );
};
